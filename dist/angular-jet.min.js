/*!
 * angular-jet is the officially supported AngularJS binding for Jet. angular-jet
 * provides you with the $jet service which allows you to easily keep your $scope
 * variables in sync with your Jet daemon / backend.
 *
 * angular-jet 0.0.0
 * https://github.com/lipp/angular-jet/
 * Date: 01/23/2015
 * License: MIT
 */
!function(a){"use strict";angular.module("jet",[]).value("jet",a.jet)}(window),function(){"use strict";angular.module("jet").factory("$jet",["$q","$timeout","$rootScope","jet",function(a,b,c,d){var e=function(e){e=e||{};var f=this.$scope=e.scope||c,g=a.defer();this.$connected=g.promise;var h=a.defer();this.$closed=h.promise;var i=b(function(){g.reject("Could not connect to: "+e.url)},e.timeout||5e3),j=!1,k=this._peer=new d.Peer({url:e.url,onOpen:function(){b.cancel(i),g.resolve(),f.$apply()},onClose:function(){h.resolve(),j||f.$apply()}}),l=this;l.$$closed=!1,f.$on("$destroy",function(){l.$$closed=!0,j=!0,k.close()})};e.prototype.$$peerCall=function(b,c,d,e){var f=a.defer(),g=this.$scope,h=this._peer;return this.$connected.then(function(){h[b](c,d,{valueAsResult:e,success:function(a){f.resolve(a),g.$apply()},error:function(a){f.reject(a),g.$apply()}})}),f.promise},e.prototype.$call=function(a,b){if(angular.isDefined(b)&&"object"!=typeof b)throw new Error("second arg to $call must be undefined, Array or Object");return this.$$peerCall("call",a,b||[])},e.prototype.$set=function(a,b,c){return this.$$peerCall("set",a,b,c)},e.prototype.$wait=function(){var b=a.defer(),c=0,d=this.$scope,e=this._peer,h=this,i={},j=Array.prototype.slice.call(arguments);return this.$connected.then(function(){var a=e.fetch({path:{equalsOneOf:j}},function(e,k,l){"add"===k?(i[e]=angular.isDefined(l)?new g({path:e,value:l},h,d):new f({path:e},h),++c,c===j.length&&(a.unfetch(),b.resolve(),d.$apply())):"remove"===k?(delete i[e],--c):i[e].$value=l},{error:function(a){b.reject(a)}})}),b.promise};var f=function(a,b){this.$path=a,this.$$angularPeer=b};f.prototype.$call=function(a){return this.$$angularPeer.$call(this.$path,a)};var g=function(a,b,c,d){this.$index=a.index,this.$path=a.path,this.$value=a.value,this.$fetchedValue=angular.copy(a.value);var e=this;e.$$saving=0,d&&d.$$autoSave&&(e.$$unwatch=c.$watch(function(){return e.$value},function(a,b){if(!angular.equals(a,b)&&d.$$applyingFetch===!1){if(e.$$reverting)return void(e.$$reverting=!1);++e.$$saving,e.$save().then(function(){--e.$$saving,delete e.$error},function(a){--e.$$saving,e.$revert=function(){e.$$reverting=!0,e.$value=angular.copy(e.$fetchedValue),delete e.$error},e.$error=a})}},!0)),e.$save=function(a){return b.$set(this.$path,this.$value,a)}};return e.prototype.$fetch=function(c,d){var e,f,h,i=this._peer,j=a.defer(),k=this.$scope,l=!1,m=this;d=d||k,c=c||{};var n={},o=function(){angular.isDefined(h)&&b.cancel(h),h=b(function(){l&&(f.$$applyingFetch=!0,d.$apply(),f.$$applyingFetch=!1),h=void 0},f.$$debounce)};if(angular.isObject(c.sort)){c.sort.asArray=!1;var p=c.sort.from||1;f=[],e=function(a,b){a.forEach(function(a){var b=a.index-p;angular.isDefined(f[b])?n[a.path]!==a.index&&f[b].$$unwatch&&f[b].$$unwatch():f[b]=new g(a,m,d,f),0===f[b].$$saving&&(f[b].$value=a.value),f[b].$path=a.path,f[b].$fetchedValue=angular.copy(a.value),n[a.path]=a.index}),f.length=b,o()}}else f=[],e=function(a,b,c){if("remove"===b){var e=n[a];f[e].$$unwatch(),f.splice(e,1),delete n[a],angular.forEach(n,function(a,b){a>e&&(this[b]=a-1)},n)}else if(angular.isDefined(c)){var h;"add"===b?(h=f.length,n[a]=h,f.push(new g({path:a},m,d,f))):h=n[a],0===f[h].$$saving&&(f[h].$value=c),f[h].$fetchedValue=angular.copy(c)}o()};return this.$connected.then(function(){f.$ref=i.fetch(c,e,{success:function(){d&&d!==k&&d.$on("$destroy",function(){f.$ref.unfetch(),l=!1,f.$active=!1}),l=!0,f.$active=!0,j.resolve(f),d.$apply()},error:function(a){j.reject(a.message),d.$apply()}})}),f.$autoSave=function(a){f.$$autoSave=a},f.$debounce=function(a){f.$$debounce=a},f.$$autoSave=!0,f.$$debounce=50,f.$$applyingFetch=!1,f.$scope=d,f.$active=!1,f.$ready=j.promise,f.$unfetch=function(){var b=a.defer();return f.$ready.then(function(){f.$ref.unfetch(),l=!1,f.$active=!1,b.resolve()}),b.promise},f},e.prototype.$close=function(){var a=this._peer;this.$connected.then(function(){a.close()})},{$Peer:e}}])}();