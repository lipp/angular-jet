/*!
 * angular-jet is the officially supported AngularJS binding for Jet. angular-jet
 * provides you with the $jet service which allows you to easily keep your $scope
 * variables in sync with your Jet daemon / backend.
 *
 * angular-jet 0.0.0
 * https://github.com/lipp/angular-jet/
 * Date: 01/30/2015
 * License: MIT
 */
!function(a){"use strict";angular.module("jet",[]).value("jet",a.jet)}(window),function(){"use strict";angular.module("jet").factory("$jet",["$q","$timeout","$rootScope","jet",function(a,b,c,d){var e=function(e){e=e||{};var f=this.$scope=e.scope||c,g=a.defer();this.$connected=g.promise;var h=a.defer();this.$closed=h.promise;var i=b(function(){g.reject("Could not connect to: "+e.url)},e.timeout||5e3),j=!1,k=this._peer=new d.Peer({url:e.url,onOpen:function(){b.cancel(i),g.resolve(),f.$apply()},onClose:function(){h.resolve(),j||f.$apply()}}),l=this;l.$$closed=!1,f.$on("$destroy",function(){l.$$closed=!0,j=!0,k.close()})};e.prototype.$$peerCall=function(b,c,d,e){var f=a.defer(),g=this.$scope,h=this._peer;return this.$connected.then(function(){h[b](c,d,{valueAsResult:e,success:function(a){f.resolve(a),g.$apply()},error:function(a){f.reject(a),g.$apply()}})}),f.promise},e.prototype.$call=function(a,b){if(angular.isDefined(b)&&"object"!=typeof b)throw new Error("second arg to $call must be undefined, Array or Object");return this.$$peerCall("call",a,b||[])},e.prototype.$set=function(a,b,c){return this.$$peerCall("set",a,b,c)},e.prototype.$wait=function(){var b=a.defer(),c=0,d=this.$scope,e=this._peer,h=this,i={},j=Array.prototype.slice.call(arguments);return this.$connected.then(function(){var a=e.fetch({path:{equalsOneOf:j}},function(e,k,l){"add"===k?(i[e]=angular.isDefined(l)?new g({path:e,value:l},h,d):new f({path:e},h),++c,c===j.length&&(a.unfetch(),b.resolve(),d.$apply())):"remove"===k?(delete i[e],--c):i[e].$value=l},{error:function(a){b.reject(a)}})}),b.promise};var f=function(a,b){this.$path=a,this.$call=function(c){return b.$call(a,c)}};f.prototype.$$unwatch=function(){};var g=function(a,b,c,d){this.$index=a.index,this.$path=a.path,this.$value=a.value,this.$fetchedValue=angular.copy(a.value);var e=this;e.$$saving=0,d&&d.$$autoSave&&(e.$$unwatch=c.$watch(function(){return e.$value},function(a,b){if(!angular.equals(a,b)&&d.$$applyingFetch===!1){if(e.$$reverting)return void(e.$$reverting=!1);++e.$$saving,e.$save().then(function(){--e.$$saving,delete e.$error},function(a){--e.$$saving,e.$revert=function(){e.$$reverting=!0,e.$value=angular.copy(e.$fetchedValue),delete e.$error},e.$error=a})}},!0)),e.$save=function(a){return b.$set(this.$path,this.$value,a)}},h=function(b){var c=this;return c.$$readyDefer=a.defer(),c.$ready=c.$$readyDefer.promise,c.$$autoSave=!0,c.$$debounce=50,c.$$applyingFetch=!1,c.$getScope=function(){return b.scope||b.peer.$scope},c.$$hasOwnScope=angular.isDefined(b.scope),c.$active=!1,c.$$getAngularPeer=function(){return b.peer},c};return h.prototype=Object.create(Array.prototype),h.prototype.$autoSave=function(a){return angular.isDefined(a)?void(this.$$autoSave=a):this.$$autoSave},h.prototype.$debounce=function(a){return angular.isDefined(a)?void(this.$$debounce=a):this.$$debounce},h.prototype.$unfetch=function(){var b=a.defer(),c=this;return this.$ready.then(function(){c.$ref.unfetch(),c.$active=!1,b.resolve()}),b.promise},h.prototype.debounceApply=function(){var a=this;angular.isDefined(this.$$debouncer)&&b.cancel(this.$$debouncer),this.$$debouncer=b(function(){a.$active&&(a.$$applyingFetch=!0,a.$getScope().$apply(),a.$$applyingFetch=!1),a.$$debouncer=void 0},this.$$debounce)},h.prototype.$$createSortedFetchCb=function(a){var b={};a.sort.asArray=!1;var c=a.sort.from||1,d=this,e=this.$$getAngularPeer(),h=this.$getScope(),i=function(a,i){var j=[],k={};if(a.forEach(function(a){var i,l=angular.isDefined(a.value),m=b[a.path],n=a.index-c;i=angular.isDefined(m)?d[m]:l?new g(a,e,h,d):new f(a.path,e),l&&0===i.$$saving&&(i.$value=a.value,i.$fetchedValue=angular.copy(a.value)),m!==n&&(b[a.path]=n,i.$index=a.index,angular.isDefined(m)&&(k[m]=d[m]),delete k[n],j.push({to:n,entry:i}))}),j.forEach(function(a){d[a.to]=a.entry}),angular.forEach(k,function(a){delete b[a.$path],a.$$unwatch&&a.$$unwatch()}),d.length>i)for(var l=i;l<d.length;++l)delete b[d[l].$path];d.length=i,d.debounceApply()};return i},h.prototype.$$createUnsortedFetchCb=function(){var a={},b=this,c=this.$$getAngularPeer(),d=this.$getScope(),e=function(e,f,h){if("remove"===f){var i=a[e];b[i].$$unwatch(),b.splice(i,1),delete a[e],angular.forEach(a,function(a,b){a>i&&(this[b]=a-1)},a)}else if(angular.isDefined(h)){var j;"add"===f?(j=b.length,a[e]=j,b.push(new g({path:e},c,d,b))):j=a[e],0===b[j].$$saving&&(b[j].$value=h),b[j].$fetchedValue=angular.copy(h)}b.debounceApply()};return e},h.prototype.$$fetch=function(a){var b,c=this;b=angular.isDefined(a.sort)?this.$$createSortedFetchCb(a):this.$$createUnsortedFetchCb(a),this.$$getAngularPeer().$connected.then(function(){c.$ref=c.$$getAngularPeer()._peer.fetch(a,b,{success:function(){c.$$hasOwnScope&&c.$getScope().$on("$destroy",function(){c.$ref.unfetch(),c.$active=!1}),c.$active=!0,c.$$readyDefer.resolve(c),c.$getScope().$apply()},error:function(a){c.$$readyDefer.reject(a.message),c.$getScope().$apply()}})})},e.prototype.$fetch=function(a,b){var c=new h({peer:this,scope:b});return c.$$fetch(a||{}),c},e.prototype.$close=function(){var a=this._peer;this.$connected.then(function(){a.close()})},{$Peer:e}}])}();